<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' https://i.ytimg.com">
  <title>YouTube History Manager</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background-color: #0f0f0f;
      color: #f1f1f1;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    header {
      background-color: #212121;
      padding: 0.75rem 1.5rem;
      border-bottom: 1px solid #303030;
      display: flex;
      align-items: center;
      gap: 2rem;
    }

    header h1 {
      font-size: 1.25rem;
      font-weight: 500;
      color: #f1f1f1;
    }

    .header-stats {
      display: flex;
      gap: 1.5rem;
      font-size: 0.875rem;
      color: #aaa;
    }

    .header-stats span {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .header-stats strong {
      color: #f1f1f1;
    }

    /* Main layout */
    .app-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background-color: #181818;
      border-right: 1px solid #303030;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      overflow-y: auto;
    }

    .sidebar-section h3 {
      font-size: 0.75rem;
      text-transform: uppercase;
      color: #717171;
      margin-bottom: 0.75rem;
      letter-spacing: 0.05em;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.625rem 1rem;
      border: none;
      border-radius: 4px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
      width: 100%;
    }

    .btn-primary {
      background-color: #3ea6ff;
      color: #0f0f0f;
    }

    .btn-primary:hover {
      background-color: #65b8ff;
    }

    .btn-primary:disabled {
      background-color: #2d2d2d;
      color: #717171;
      cursor: not-allowed;
    }

    .btn-secondary {
      background-color: #272727;
      color: #f1f1f1;
    }

    .btn-secondary:hover {
      background-color: #3f3f3f;
    }

    /* Search */
    .search-box {
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 0.625rem 0.75rem 0.625rem 2.25rem;
      background-color: #121212;
      border: 1px solid #303030;
      border-radius: 4px;
      color: #f1f1f1;
      font-size: 0.875rem;
    }

    .search-box input:focus {
      outline: none;
      border-color: #3ea6ff;
    }

    .search-box::before {
      content: "üîç";
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.75rem;
    }

    /* Filters */
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .filter-group label {
      font-size: 0.75rem;
      color: #aaa;
    }

    .filter-group select,
    .filter-group input[type="date"] {
      padding: 0.5rem;
      background-color: #121212;
      border: 1px solid #303030;
      border-radius: 4px;
      color: #f1f1f1;
      font-size: 0.875rem;
    }

    .filter-group select:focus,
    .filter-group input[type="date"]:focus {
      outline: none;
      border-color: #3ea6ff;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
    }

    .checkbox-group input[type="checkbox"] {
      width: 1rem;
      height: 1rem;
    }

    /* Import status */
    .import-status {
      background-color: #272727;
      padding: 0.75rem;
      border-radius: 4px;
      font-size: 0.75rem;
      color: #aaa;
      display: none;
    }

    .import-status.visible {
      display: block;
    }

    .import-status.success {
      background-color: #1e3a2f;
      color: #4ade80;
    }

    .import-status.error {
      background-color: #3a1e1e;
      color: #f87171;
    }

    /* Main content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* History list */
    .history-list {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .history-item {
      display: flex;
      gap: 1rem;
      padding: 0.75rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .history-item:hover {
      background-color: #272727;
    }

    .history-item.ad {
      opacity: 0.6;
    }

    .history-item .thumbnail {
      width: 160px;
      height: 90px;
      border-radius: 8px;
      object-fit: cover;
      background-color: #303030;
      flex-shrink: 0;
    }

    .history-item .details {
      flex: 1;
      min-width: 0;
    }

    .history-item .title {
      font-size: 0.9375rem;
      font-weight: 500;
      color: #f1f1f1;
      margin-bottom: 0.25rem;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .history-item .channel {
      font-size: 0.8125rem;
      color: #aaa;
      margin-bottom: 0.25rem;
    }

    .history-item .meta {
      font-size: 0.75rem;
      color: #717171;
      display: flex;
      gap: 0.5rem;
    }

    .history-item .badge {
      background-color: #3f3f3f;
      padding: 0.125rem 0.375rem;
      border-radius: 2px;
      font-size: 0.625rem;
      text-transform: uppercase;
    }

    .history-item .badge.ad-badge {
      background-color: #854d0e;
      color: #fef08a;
    }

    /* Pagination */
    .pagination {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      padding: 1rem;
      border-top: 1px solid #303030;
      background-color: #181818;
    }

    .pagination button {
      padding: 0.5rem 1rem;
      background-color: #272727;
      border: none;
      border-radius: 4px;
      color: #f1f1f1;
      cursor: pointer;
    }

    .pagination button:hover:not(:disabled) {
      background-color: #3f3f3f;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination .page-info {
      font-size: 0.875rem;
      color: #aaa;
    }

    /* Empty state */
    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #717171;
      text-align: center;
      padding: 2rem;
    }

    .empty-state h2 {
      font-size: 1.25rem;
      color: #aaa;
      margin-bottom: 0.5rem;
    }

    .empty-state p {
      font-size: 0.875rem;
      margin-bottom: 1.5rem;
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      color: #717171;
    }

    /* Last import info */
    .last-import {
      font-size: 0.75rem;
      color: #717171;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>YouTube History</h1>
    <div class="header-stats">
      <span>Videos: <strong id="stat-total">-</strong></span>
      <span>Non-ads: <strong id="stat-nonads">-</strong></span>
      <span>Latest: <strong id="stat-latest">-</strong></span>
    </div>
  </header>

  <div class="app-container">
    <aside class="sidebar">
      <div class="sidebar-section">
        <h3>Import</h3>
        <button class="btn btn-primary" id="btn-import">
          Import Takeout
        </button>
        <div class="import-status" id="import-status"></div>
        <div class="last-import" id="last-import"></div>
      </div>

      <div class="sidebar-section">
        <h3>Search</h3>
        <div class="search-box">
          <input type="text" id="search-input" placeholder="Search videos...">
        </div>
      </div>

      <div class="sidebar-section">
        <h3>Filters</h3>
        <div class="filter-group">
          <label>Sort by</label>
          <select id="filter-sort">
            <option value="watchedAt-desc">Date (newest first)</option>
            <option value="watchedAt-asc">Date (oldest first)</option>
            <option value="title-asc">Title (A-Z)</option>
            <option value="title-desc">Title (Z-A)</option>
            <option value="channelName-asc">Channel (A-Z)</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Date from</label>
          <input type="date" id="filter-date-from">
        </div>
        <div class="filter-group">
          <label>Date to</label>
          <input type="date" id="filter-date-to">
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="filter-hide-ads">
          <label for="filter-hide-ads">Hide ads</label>
        </div>
      </div>

      <div class="sidebar-section" style="margin-top: auto;">
        <button class="btn btn-secondary" id="btn-clear-filters">
          Clear Filters
        </button>
      </div>
    </aside>

    <main class="main-content">
      <div class="history-list" id="history-list">
        <div class="loading">Loading...</div>
      </div>

      <div class="pagination" id="pagination" style="display: none;">
        <button id="btn-prev">Previous</button>
        <span class="page-info" id="page-info">Page 1</span>
        <button id="btn-next">Next</button>
      </div>
    </main>
  </div>

  <script>
    // State
    let currentPage = 1;
    const pageSize = 50;
    let totalEntries = 0;
    let searchTimeout = null;

    // Elements
    const historyList = document.getElementById('history-list');
    const pagination = document.getElementById('pagination');
    const pageInfo = document.getElementById('page-info');
    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');
    const btnImport = document.getElementById('btn-import');
    const importStatus = document.getElementById('import-status');
    const lastImport = document.getElementById('last-import');
    const searchInput = document.getElementById('search-input');
    const filterSort = document.getElementById('filter-sort');
    const filterDateFrom = document.getElementById('filter-date-from');
    const filterDateTo = document.getElementById('filter-date-to');
    const filterHideAds = document.getElementById('filter-hide-ads');
    const btnClearFilters = document.getElementById('btn-clear-filters');

    // Stats elements
    const statTotal = document.getElementById('stat-total');
    const statNonads = document.getElementById('stat-nonads');
    const statLatest = document.getElementById('stat-latest');

    // Format date for display
    function formatDate(isoString) {
      if (!isoString) return '-';
      const date = new Date(isoString);
      return date.toLocaleDateString(undefined, {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
      });
    }

    // Format relative time
    function formatRelativeTime(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      const now = new Date();
      const diff = now - date;
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));

      if (days === 0) return 'Today';
      if (days === 1) return 'Yesterday';
      if (days < 7) return `${days} days ago`;
      if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
      if (days < 365) return `${Math.floor(days / 30)} months ago`;
      return `${Math.floor(days / 365)} years ago`;
    }

    // Get current filter options
    function getQueryOptions() {
      const [orderBy, orderDir] = filterSort.value.split('-');
      return {
        limit: pageSize,
        offset: (currentPage - 1) * pageSize,
        orderBy,
        orderDir,
        search: searchInput.value || undefined,
        dateFrom: filterDateFrom.value ? filterDateFrom.value + 'T00:00:00.000Z' : undefined,
        dateTo: filterDateTo.value ? filterDateTo.value + 'T23:59:59.999Z' : undefined,
        includeAds: !filterHideAds.checked,
      };
    }

    // Load stats
    async function loadStats() {
      try {
        const stats = await window.electronAPI.getStats();
        statTotal.textContent = stats.total.toLocaleString();
        statNonads.textContent = stats.nonAds.toLocaleString();
        statLatest.textContent = formatRelativeTime(stats.latestWatched);

        if (stats.lastTakeoutImport) {
          lastImport.textContent = `Last import: ${formatDate(stats.lastTakeoutImport)}`;
        }
      } catch (err) {
        console.error('Failed to load stats:', err);
      }
    }

    // Load history
    async function loadHistory() {
      historyList.innerHTML = '<div class="loading">Loading...</div>';

      try {
        const options = getQueryOptions();
        const result = await window.electronAPI.getHistory(options);
        totalEntries = result.total;

        if (result.entries.length === 0) {
          historyList.innerHTML = `
            <div class="empty-state">
              <h2>No videos found</h2>
              <p>${searchInput.value ? 'Try a different search term.' : 'Import your Google Takeout file to get started.'}</p>
            </div>
          `;
          pagination.style.display = 'none';
          return;
        }

        historyList.innerHTML = result.entries.map(entry => `
          <div class="history-item ${entry.isAd ? 'ad' : ''}" data-url="${entry.url}">
            <img class="thumbnail" src="${entry.thumbnailUrl}" alt="" loading="lazy" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 16 9%22><rect fill=%22%23303030%22 width=%2216%22 height=%229%22/></svg>'">
            <div class="details">
              <div class="title">${escapeHtml(entry.title)}</div>
              <div class="channel">${escapeHtml(entry.channelName || 'Unknown channel')}</div>
              <div class="meta">
                <span>${formatDate(entry.watchedAt)}</span>
                ${entry.isAd ? '<span class="badge ad-badge">Ad</span>' : ''}
                <span class="badge">${entry.source}</span>
              </div>
            </div>
          </div>
        `).join('');

        // Add click handlers
        historyList.querySelectorAll('.history-item').forEach(item => {
          item.addEventListener('click', () => {
            const url = item.dataset.url;
            if (url) {
              window.open(url, '_blank');
            }
          });
        });

        // Update pagination
        const totalPages = Math.ceil(totalEntries / pageSize);
        pageInfo.textContent = `Page ${currentPage} of ${totalPages} (${totalEntries.toLocaleString()} videos)`;
        btnPrev.disabled = currentPage === 1;
        btnNext.disabled = currentPage >= totalPages;
        pagination.style.display = totalPages > 1 ? 'flex' : 'none';

      } catch (err) {
        console.error('Failed to load history:', err);
        historyList.innerHTML = `
          <div class="empty-state">
            <h2>Error loading history</h2>
            <p>${err.message || 'An error occurred.'}</p>
          </div>
        `;
      }
    }

    // Escape HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Import handler
    btnImport.addEventListener('click', async () => {
      btnImport.disabled = true;
      importStatus.className = 'import-status visible';
      importStatus.textContent = 'Selecting file...';

      try {
        const filePath = await window.electronAPI.showOpenDialog();
        if (!filePath) {
          importStatus.className = 'import-status';
          btnImport.disabled = false;
          return;
        }

        importStatus.textContent = 'Importing...';
        const result = await window.electronAPI.importTakeout(filePath);

        if (result.success) {
          importStatus.className = 'import-status visible success';
          importStatus.textContent = `Imported ${result.stats.inserted.toLocaleString()} videos (${result.stats.duplicatesInDb.toLocaleString()} duplicates skipped)`;
          await loadStats();
          await loadHistory();
        } else {
          importStatus.className = 'import-status visible error';
          importStatus.textContent = `Error: ${result.error}`;
        }
      } catch (err) {
        importStatus.className = 'import-status visible error';
        importStatus.textContent = `Error: ${err.message || 'Import failed'}`;
      } finally {
        btnImport.disabled = false;
      }
    });

    // Pagination handlers
    btnPrev.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        loadHistory();
        historyList.scrollTop = 0;
      }
    });

    btnNext.addEventListener('click', () => {
      const totalPages = Math.ceil(totalEntries / pageSize);
      if (currentPage < totalPages) {
        currentPage++;
        loadHistory();
        historyList.scrollTop = 0;
      }
    });

    // Search handler with debounce
    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        currentPage = 1;
        loadHistory();
      }, 300);
    });

    // Filter handlers
    filterSort.addEventListener('change', () => {
      currentPage = 1;
      loadHistory();
    });

    filterDateFrom.addEventListener('change', () => {
      currentPage = 1;
      loadHistory();
    });

    filterDateTo.addEventListener('change', () => {
      currentPage = 1;
      loadHistory();
    });

    filterHideAds.addEventListener('change', () => {
      currentPage = 1;
      loadHistory();
    });

    // Clear filters
    btnClearFilters.addEventListener('click', () => {
      searchInput.value = '';
      filterSort.value = 'watchedAt-desc';
      filterDateFrom.value = '';
      filterDateTo.value = '';
      filterHideAds.checked = false;
      currentPage = 1;
      loadHistory();
    });

    // Initial load
    loadStats();
    loadHistory();
  </script>
</body>
</html>
